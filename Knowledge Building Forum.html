<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>çŸ¥è­˜å»ºæ§‹å”ä½œå¹³å° (KB Platform) - Mobile Optimized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module">
    // ==========================================
    // [PART 1] Firebase é›²ç«¯è¨­å®šå€
    // ==========================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // âš ï¸ è«‹åœ¨æ­¤è™•è²¼ä¸Šæ‚¨çš„ Firebase Config (å¾å¾Œå°è¤‡è£½çš„é‚£ä¸€æ•´æ®µ)
const firebaseConfig = { 
  apiKey ï¼š"AIzaSyDPjtxtf656JHVVlj1o4cLwSylo1jDBFAc" , 
  authDomain : "kb-platform-1.firebaseapp.com" , 
  databaseURL : "https://kb-platform-1-default-rtdb.firebaseio.com" , 
  projectId : "kb-platform-1" , 
  storageBucket : "kb-platform-1.firebasestorage.app" , 
  messagingSenderId : "230026226847" , 
  appId : "1:230026226847:web:49e6f09ddfc3de0ef046aa" 
};

    // åˆå§‹åŒ–é›²ç«¯
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db, 'kb_forum_data_v1');

    // å°‡ Firebase æ¨¡çµ„æ›è¼‰åˆ° windowï¼Œè®“ä¸‹æ–¹çš„èˆŠç¨‹å¼ç¢¼å¯ä»¥å‘¼å«
    window.firebaseModules = { db, ref, set, update };

    console.log("â˜ï¸ é›²ç«¯æ¨¡çµ„å·²è¼‰å…¥...");

    // ==========================================
    // [PART 2] æ ¸å¿ƒè³‡æ–™ç®¡ç†å™¨ (å·²æ”¹å¯«ç‚ºé›²ç«¯ç‰ˆ)
    // ==========================================
    
    // å®šç¾©é è¨­è³‡æ–™ (é¿å…é›²ç«¯æ˜¯ç©ºçš„æ™‚ç™¼ç”ŸéŒ¯èª¤)
    window.SEED_DATA = {
        userList: {
            teacher: { id: 'u1', name: 'ç‹æ•™æˆ', role: 'teacher', avatar: 'https://api.dicebear.com/9.x/notionists/svg?seed=Felix' },
            student1: { id: 'u2', name: 'å°ç¾', role: 'student', avatar: 'https://api.dicebear.com/9.x/notionists/svg?seed=S1' },
            student2: { id: 'u3', name: 'å¤§è¯', role: 'student', avatar: 'https://api.dicebear.com/9.x/notionists/svg?seed=S2' }
        },
        topics: [
            { id: 't1', name: 'ç¯„ä¾‹ä¸»é¡Œï¼šç‚ºä»€éº¼å¤©ç©ºæ˜¯è—è‰²çš„ï¼Ÿ', categories: ['ç§‘å­¸'], desc: 'é€™æ˜¯ä¸€å€‹æ¸¬è©¦ä¸»é¡Œ', author: 'u1', date: Date.now() }
        ],
        nodes: [],
        trash: []
    };

    // åˆå§‹åŒ–å…¨åŸŸç‹€æ…‹
    window.state = {
        user: null, userList: {}, topics: [], nodes: [], trash: [], 
        currentView: 'entrance', currentTopicId: null,
        activeFilter: 'å…¨éƒ¨', tempSelectedCategories: [], editingTopicId: null,
        canvas: { scale: 1, offsetX: 0, offsetY: 0, isDragging: false, lastX: 0, lastY: 0, draggedNodeId: null, isClusterMode: false, isHeatmapMode: false, isPinching: false, lastPinchDist: 0, startPinchScale: 1, isPanMode: false, isSelecting: false, selectionStart: {x:0, y:0}, selectionCurrent: {x:0, y:0} },
        selectedNodeIds: [], composer: { parentId: null, selectedScaffold: null }, profile: null
    };

    // é‡æ–°å®šç¾© dataManager
    window.dataManager = {
        save: () => {
            // å„²å­˜è‡³é›²ç«¯
            const exportData = {
                userList: window.state.userList,
                topics: window.state.topics,
                nodes: window.state.nodes,
                trash: window.state.trash
            };
            set(dbRef, exportData).catch(err => console.error("é›²ç«¯å„²å­˜å¤±æ•—:", err));
            
            // å¦å¤–å„²å­˜å€‹äººçš„ã€Œç•¶å‰ä½¿ç”¨è€…ã€ç‹€æ…‹åœ¨æœ¬åœ°ï¼Œé€™æ¨£é‡æ•´ç¶²é æ‰ä¸æœƒç™»å‡º
            if(window.state.user) {
                localStorage.setItem('kb_local_user_id', window.state.user.id);
            }
        },
        load: () => {
            // ç©ºå‡½å¼ï¼Œå› ç‚ºæˆ‘å€‘æ”¹ç”¨ä¸‹æ–¹çš„å³æ™‚ç›£è½ (onValue)
            console.log("ç­‰å¾…é›²ç«¯æ•¸æ“šåŒæ­¥...");
        },
        reset: () => {
            if(confirm("ç¢ºå®šè¦æ¸…ç©ºé›²ç«¯æ‰€æœ‰è³‡æ–™å—ï¼Ÿ")) {
                set(dbRef, null).then(() => window.location.reload());
            }
        }
    };

    // ==========================================
    // [PART 3] å•Ÿå‹•å¼•æ“ (ç›£è½é›²ç«¯æ•¸æ“š + å•Ÿå‹• UI)
    // ==========================================
    
    // ç•¶é›²ç«¯æ•¸æ“šæ”¹è®Šæ™‚ï¼Œè‡ªå‹•æ›´æ–°ç•«é¢
    onValue(dbRef, (snapshot) => {
        const cloudData = snapshot.val();
        
        if (cloudData) {
            console.log("ğŸ“¥ æ”¶åˆ°é›²ç«¯æ•¸æ“šï¼Œæ­£åœ¨æ›´æ–°ç•«é¢...");
            window.state.userList = cloudData.userList || window.SEED_DATA.userList;
            window.state.topics = cloudData.topics || window.SEED_DATA.topics;
            window.state.nodes = cloudData.nodes || window.SEED_DATA.nodes;
            window.state.trash = cloudData.trash || [];
        } else {
            console.log("âœ¨ é›²ç«¯ç„¡è³‡æ–™ï¼Œåˆå§‹åŒ–ä¸­...");
            window.state.userList = window.SEED_DATA.userList;
            window.state.topics = window.SEED_DATA.topics;
            window.dataManager.save(); // ä¸Šå‚³ç¨®å­è³‡æ–™
        }

        // æ¢å¾©ä½¿ç”¨è€…ç™»å…¥ç‹€æ…‹
        const savedUserId = localStorage.getItem('kb_local_user_id');
        const currentUserKey = Object.keys(window.state.userList).find(k => window.state.userList[k].id === savedUserId);
        
        if (currentUserKey) {
            window.state.user = window.state.userList[currentUserKey];
        } else {
            // é è¨­ç™»å…¥ç¬¬ä¸€ä½è€å¸«
            const firstUserKey = Object.keys(window.state.userList)[0];
            window.state.user = window.state.userList[firstUserKey];
        }

        // å¼·åˆ¶åˆ·æ–° UI (å¦‚æœ UI å·²ç¶“æº–å‚™å¥½)
        if (window.ui && window.ui.renderEntrance) {
            // åˆ¤æ–·ç›®å‰åœ¨å“ªå€‹é é¢ï¼Œå°±åˆ·æ–°å“ªå€‹
            if(window.state.currentView === 'canvas') window.ui.renderCanvas();
            else if(window.state.currentView === 'profile') window.ui.renderProfile();
            else window.ui.renderEntrance();
            
            window.ui.renderUserInfo();
            window.ui.renderUserMenu();
            window.app.updateTrashBadge();
        }
    });

    // ==========================================
    // [PART 4] æ‚¨åŸæœ¬çš„ UI é‚è¼¯ (æˆ‘å¹«æ‚¨ä¿ç•™åœ¨é€™è£¡)
    // ==========================================
    
    // å…¨åŸŸå¸¸æ•¸
    window.ROLES = { LEAD: 'teacher', CO: 'student' };
    window.SCAFFOLDS = {
        question: { id: 'question', label: 'Question', icon: 'fa-circle-question', color: 'bg-blue-500', border: 'border-blue-500', bgSoft: 'bg-blue-50', text: 'text-blue-700', desc: 'æå‡ºä½ æ„Ÿèˆˆè¶£çš„å•é¡Œæˆ–ç›®å‰çš„å›°æƒ‘ã€‚' },
        extend: { id: 'extend', label: 'Build on', icon: 'fa-plus', color: 'bg-yellow-500', border: 'border-yellow-500', bgSoft: 'bg-yellow-50', text: 'text-yellow-700', desc: 'è£œå……æ›´å¤šè³‡è¨Šæˆ–æ¥çºŒè¨è«–ã€‚' },
        improve: { id: 'improve', label: 'Improve', icon: 'fa-bolt', color: 'bg-green-500', border: 'border-green-500', bgSoft: 'bg-green-50', text: 'text-green-700', desc: 'ä¿®æ­£è§€é»æˆ–æå‡ºæ›´å¥½çš„è§£é‡‹ã€‚' },
        counter: { id: 'counter', label: 'Counter', icon: 'fa-triangle-exclamation', color: 'bg-red-500', border: 'border-red-500', bgSoft: 'bg-red-50', text: 'text-red-700', desc: 'æå‡ºä¸åŒçš„çœ‹æ³•æˆ–åä¾‹ã€‚' },
        riseabove: { id: 'riseabove', label: 'Rise Above', icon: 'fa-rocket', color: 'bg-purple-500', border: 'border-purple-500', bgSoft: 'bg-purple-50', text: 'text-purple-700', desc: 'æ•´åˆè¨è«–ï¼Œæå‡ºæ›´é«˜å±¤æ¬¡çš„çµè«–ã€‚' }
    };
    window.TOPIC_CATEGORIES = { 'ç§‘å­¸': 'ğŸ”¬ ç§‘å­¸', 'STEAM': 'ğŸ’¡ STEAM', 'å°ˆé¡Œèª²': 'ğŸ“ å°ˆé¡Œèª²', 'é›»æ©Ÿé›»å­': 'ğŸ“¡ é›»æ©Ÿé›»å­', 'AI': 'ğŸ¤– AI', 'èªè¨€å­¸ç¿’': 'ğŸ“™ èªè¨€å­¸ç¿’', 'æ–‡å­¸': 'ğŸ“– æ–‡å­¸', 'ç¤¾æœƒè­°é¡Œ': 'â˜ï¸ ç¤¾æœƒè­°é¡Œ', 'ç‰©ç†': 'âš›ï¸ ç‰©ç†å­¸', 'å‹•æ¼«': 'ğŸ¨ å‹•æ¼«', 'ç¨‹å¼': 'ğŸ’» ç¨‹å¼è¨­è¨ˆ', 'æ­·å²': 'ğŸ“œ æ­·å²', 'å“²å­¸': 'ğŸ¤” å“²å­¸', 'è—è¡“': 'ğŸ­ è—è¡“', 'å…¶ä»–': 'ğŸ“¦ å…¶ä»–' };
    window.CLUSTER_CENTERS = { 'A': {x: 250, y: 300, title: 'æ ¸å¿ƒå•é¡Œæ¢ç©¶å€', width: 600, height: 600}, 'B': {x: 1050, y: 300, title: 'å»¶ä¼¸è®Šå› è¨è«–å€', width: 600, height: 600}, 'C': {x: 650, y: 1000, title: 'çŸ¥è­˜æ˜‡è¯æ•´åˆå€', width: 800, height: 500} };

    window.app = {};
    window.app.generateCategoryFilters = () => {
        let html = `<button class="px-4 py-1.5 rounded-full text-sm font-medium filter-btn transition ${window.state.activeFilter === 'å…¨éƒ¨' ? 'active bg-slate-200 text-slate-900 border-slate-300' : 'bg-white text-slate-500 border border-slate-200'}" data-category="å…¨éƒ¨">æ‰€æœ‰ä¸»é¡Œ</button>`;
        html += Object.keys(window.TOPIC_CATEGORIES).map(key => {
            const isActive = window.state.activeFilter === key;
            return `<button class="px-4 py-1.5 rounded-full text-sm font-medium filter-btn transition ${isActive ? 'active bg-indigo-50 text-indigo-700 border-indigo-200' : 'bg-white text-slate-500 border border-slate-200'}" data-category="${key}">${window.TOPIC_CATEGORIES[key]}</button>`;
        }).join('');
        return html;
    };
    window.app.setFilter = (category) => { window.state.activeFilter = category; window.ui.renderEntrance(); };
    window.app.renderCategorySelector = () => {
        const container = document.getElementById('topic-category-selector'); if(!container) return;
        container.innerHTML = Object.keys(window.TOPIC_CATEGORIES).map(key => {
            const isSelected = window.state.tempSelectedCategories.includes(key);
            return `<span onclick="window.app.toggleTempCategory('${key}')" class="category-tag px-3 py-1 rounded-full text-xs font-bold border ${isSelected ? 'selected' : 'bg-white text-slate-500 border-slate-200'}">${window.TOPIC_CATEGORIES[key]}</span>`;
        }).join('');
    };
    window.app.toggleTempCategory = (key) => {
        if (window.state.tempSelectedCategories.includes(key)) { window.state.tempSelectedCategories = window.state.tempSelectedCategories.filter(c => c !== key); } else { window.state.tempSelectedCategories.push(key); }
        window.app.renderCategorySelector();
    };
    
    // è·¯ç”±èˆ‡ä½¿ç”¨è€…åŠŸèƒ½
    window.app.router = (view) => {
        if (view === 'canvas' && !window.state.currentTopicId) { window.ui.showToast('è«‹å…ˆé¸æ“‡ä¸€å€‹ä¸»é¡Œ', 'error'); window.app.router('entrance'); return; }
        window.state.currentView = view;
        if(view === 'entrance') window.state.currentTopicId = null;
        window.dataManager.save(); // åŒæ­¥ç‹€æ…‹
        window.ui.updateNav(view);
        document.getElementById('user-menu').classList.add('hidden');
        if(view === 'entrance') window.ui.renderEntrance();
        else if(view === 'canvas') window.ui.renderCanvas();
        else if(view === 'profile') window.ui.renderProfile();
    };
    window.app.toggleUserMenu = () => document.getElementById('user-menu').classList.toggle('hidden');
    window.app.openAddUserModal = () => { document.getElementById('modal-addUser').classList.remove('hidden'); document.getElementById('user-menu').classList.add('hidden'); };
    window.app.createNewUser = () => {
        const name = document.getElementById('new-user-name').value.trim();
        const role = document.getElementById('new-user-role').value;
        if (!name) return window.ui.showToast('æš±ç¨±ä¸èƒ½ç‚ºç©º', 'error');
        const newKey = `user${Date.now()}`;
        window.state.userList[newKey] = { id: `u${Date.now()}`, name, role, avatar: `https://api.dicebear.com/9.x/notionists/svg?seed=${name}` };
        window.dataManager.save();
        window.ui.closeModal('modal-addUser');
        window.app.switchUser(newKey);
    };
    window.app.deleteUser = (key) => {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤ä½¿ç”¨è€…ï¼Ÿ")) {
            delete window.state.userList[key];
            window.dataManager.save();
            window.ui.renderUserMenu();
        }
    };
    window.app.switchUser = (userKey) => {
        if (!window.state.userList[userKey]) return;
        window.state.user = window.state.userList[userKey];
        window.dataManager.save();
        window.ui.renderUserInfo();
        window.ui.renderUserMenu();
        window.ui.showToast(`å·²åˆ‡æ›ï¼š${window.state.user.name}`);
        document.getElementById('user-menu').classList.add('hidden');
    };

    // ä¸»é¡Œèˆ‡ç­†è¨˜åŠŸèƒ½
    window.app.openCreateTopic = () => {
        window.state.editingTopicId = null;
        document.getElementById('topic-name').value = '';
        document.getElementById('topic-desc').value = '';
        window.state.tempSelectedCategories = [];
        window.app.renderCategorySelector();
        document.getElementById('modal-topic').classList.remove('hidden');
    };
    window.app.openEditTopic = (id) => {
        const t = window.state.topics.find(t => t.id === id);
        if(!t) return;
        window.state.editingTopicId = id;
        document.getElementById('topic-name').value = t.name;
        document.getElementById('topic-desc').value = t.desc;
        window.state.tempSelectedCategories = t.categories || [];
        window.app.renderCategorySelector();
        document.getElementById('modal-topic').classList.remove('hidden');
    };
    window.app.saveTopic = () => {
        const name = document.getElementById('topic-name').value;
        const desc = document.getElementById('topic-desc').value;
        if(!name) return window.ui.showToast('è«‹è¼¸å…¥ä¸»é¡Œåç¨±', 'error');
        
        if(window.state.editingTopicId) {
            const t = window.state.topics.find(t => t.id === window.state.editingTopicId);
            if(t) { t.name = name; t.desc = desc; t.categories = window.state.tempSelectedCategories; }
        } else {
            window.state.topics.unshift({
                id: 't'+Date.now(), name, desc, categories: window.state.tempSelectedCategories, author: window.state.user.id, date: Date.now()
            });
        }
        window.dataManager.save();
        window.ui.closeModal('modal-topic');
        window.ui.renderEntrance();
    };
    window.app.deleteTopic = (id) => {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤ä¸»é¡Œï¼Ÿ")) {
            window.state.topics = window.state.topics.filter(t => t.id !== id);
            window.state.nodes = window.state.nodes.filter(n => n.topicId !== id);
            window.dataManager.save();
            window.ui.renderEntrance();
        }
    };
    window.app.enterTopic = (id) => {
        window.state.currentTopicId = id;
        window.app.router('canvas');
    };
    
    // Canvas & Nodes
    window.app.openComposer = (pid) => {
        window.state.composer.parentId = pid;
        document.getElementById('scaffold-selector').innerHTML = Object.values(window.SCAFFOLDS).map(s => `
            <button onclick="window.app.selectScaffold('${s.id}')" id="btn-scaffold-${s.id}" class="flex flex-col items-center justify-center p-2 rounded-lg border-2 border-slate-100 opacity-60 transition hover:opacity-80">
                <div class="w-8 h-8 rounded-full ${s.color} text-white flex justify-center items-center mb-1"><i class="fa-solid ${s.icon}"></i></div>
                <span class="text-xs font-bold text-slate-600">${s.label}</span>
            </button>`).join('');
        document.getElementById('node-title').value = '';
        document.getElementById('node-content').value = '';
        document.getElementById('modal-node').classList.remove('hidden');
    };
    window.app.selectScaffold = (id) => {
        window.state.composer.selectedScaffold = id;
        Object.values(window.SCAFFOLDS).forEach(s => {
            const btn = document.getElementById(`btn-scaffold-${s.id}`);
            if(s.id === id) { btn.classList.remove('opacity-60','border-slate-100'); btn.classList.add('opacity-100',s.border,s.bgSoft); }
            else { btn.classList.add('opacity-60','border-slate-100'); btn.classList.remove('opacity-100',s.border,s.bgSoft); }
        });
    };
    window.app.submitNode = () => {
        if(!window.state.composer.selectedScaffold) return window.ui.showToast('è«‹é¸æ“‡é¡å‹', 'error');
        const title = document.getElementById('node-title').value;
        const content = document.getElementById('node-content').value;
        if(!title || !content) return window.ui.showToast('å…§å®¹ä¸å®Œæ•´', 'error');
        
        let nx, ny;
        if(window.state.composer.parentId) {
            const p = window.state.nodes.find(n => n.id === window.state.composer.parentId);
            nx = p.x + (Math.random()*100 - 50); ny = p.y + 200;
        } else {
            const wrap = document.getElementById('canvas-wrapper');
            nx = -window.state.canvas.offsetX + wrap.clientWidth/2 - 140;
            ny = -window.state.canvas.offsetY + wrap.clientHeight/2 - 100;
        }

        window.state.nodes.push({
            id: 'n'+Date.now(), topicId: window.state.currentTopicId,
            type: window.state.composer.selectedScaffold, title, content,
            author: window.state.user.id, date: Date.now(), x: nx, y: ny, parentId: window.state.composer.parentId,
            cluster: ['A','B','C'][Math.floor(Math.random()*3)], promisingness: Math.floor(Math.random()*100)
        });
        window.dataManager.save();
        window.ui.closeModal('modal-node');
        window.ui.renderCanvas();
    };
    
    // Trash
    window.app.openTrash = () => { window.ui.renderTrashList(); document.getElementById('modal-trash').classList.remove('hidden'); };
    window.app.emptyTrash = () => { window.state.trash = []; window.dataManager.save(); window.ui.renderTrashList(); window.app.updateTrashBadge(); };
    window.app.updateTrashBadge = () => {
        const badge = document.getElementById('trash-count-badge');
        if(badge) {
            badge.innerText = window.state.trash.length;
            if(window.state.trash.length > 0) badge.classList.remove('hidden'); else badge.classList.add('hidden');
        }
    };

    // Canvas Interaction Module
    window.app.canvas = {
        applyTransform: () => {
            const el = document.getElementById('canvas-content');
            if(el) el.style.transform = `translate(${window.state.canvas.offsetX}px, ${window.state.canvas.offsetY}px) scale(${window.state.canvas.scale})`;
            const bg = document.getElementById('canvas-bg');
            if(bg) bg.style.backgroundPosition = `${window.state.canvas.offsetX}px ${window.state.canvas.offsetY}px`;
        },
        toggleMode: () => {
            window.state.canvas.isPanMode = !window.state.canvas.isPanMode;
            window.ui.renderCanvas();
            window.ui.showToast(window.state.canvas.isPanMode ? 'å·²åˆ‡æ›ç‚ºï¼šæ‹–æ›³æ¨¡å¼' : 'å·²åˆ‡æ›ç‚ºï¼šé¸å–æ¨¡å¼');
        },
        startPan: (e) => {
            if(e.target.closest('.node-card')) return;
            window.state.canvas.isDragging = true;
            window.state.canvas.lastX = e.clientX || e.touches[0].clientX;
            window.state.canvas.lastY = e.clientY || e.touches[0].clientY;
        },
        pan: (e) => {
            if(!window.state.canvas.isDragging) return;
            const cx = e.clientX || e.touches[0].clientX;
            const cy = e.clientY || e.touches[0].clientY;
            window.state.canvas.offsetX += cx - window.state.canvas.lastX;
            window.state.canvas.offsetY += cy - window.state.canvas.lastY;
            window.state.canvas.lastX = cx; window.state.canvas.lastY = cy;
            window.app.canvas.applyTransform();
        },
        endPan: () => { window.state.canvas.isDragging = false; },
        startDragNode: (e, id) => {
            window.state.canvas.draggedNodeId = id;
            window.state.canvas.lastX = e.clientX || e.touches[0].clientX;
            window.state.canvas.lastY = e.clientY || e.touches[0].clientY;
        },
        zoom: (delta) => {
            window.state.canvas.scale = Math.min(Math.max(0.2, window.state.canvas.scale + delta), 3);
            window.app.canvas.applyTransform();
        }
    };

    // ==========================================
    // [PART 5] UI æ¸²æŸ“é‚è¼¯ (View)
    // ==========================================
    window.ui = {};
    window.ui.init = () => {
        // åˆå§‹è·¯ç”±ç”± onValue æ±ºå®šï¼Œé€™è£¡å…ˆæ›è¼‰äº‹ä»¶
        window.addEventListener('resize', () => { if(window.state.currentView === 'canvas') window.ui.renderCanvas(); });
    };
    
    window.ui.renderUserInfo = () => {
        if(!window.state.user) return;
        const u = window.state.user;
        document.getElementById('user-avatar').src = u.avatar;
        document.getElementById('user-name').innerText = u.name;
        document.getElementById('user-role').innerText = u.role === 'teacher' ? 'é¦–å¸­' : 'å”åŒ';
    };
    
    window.ui.renderUserMenu = () => {
        const list = Object.entries(window.state.userList).map(([k, u]) => `
            <div class="flex items-center hover:bg-slate-50 border-b border-slate-50 p-2">
                <button onclick="window.app.switchUser('${k}')" class="flex-1 text-left flex items-center gap-2">
                    <img src="${u.avatar}" class="w-6 h-6 rounded-full"> <span>${u.name}</span>
                </button>
                ${window.state.user.role === 'teacher' ? `<button onclick="window.app.deleteUser('${k}')" class="text-red-400"><i class="fa-solid fa-trash"></i></button>` : ''}
            </div>`).join('');
        document.getElementById('user-menu').innerHTML = `<div class="p-2">${list}</div><div class="p-2 border-t"><button onclick="window.app.openAddUserModal()" class="w-full text-center text-blue-600 font-bold">æ–°å¢ä½¿ç”¨è€…</button><button onclick="window.dataManager.reset()" class="w-full text-center text-red-400 text-xs mt-2">é‡ç½®ç³»çµ±</button></div>`;
    };

    window.ui.renderEntrance = () => {
        const container = document.getElementById('app-container');
        const visibleTopics = window.state.activeFilter === 'å…¨éƒ¨' ? window.state.topics : window.state.topics.filter(t => t.categories.includes(window.state.activeFilter));
        
        container.innerHTML = `
        <div class="max-w-7xl mx-auto px-6 py-8 h-full overflow-y-auto pb-24">
            <div class="mb-6 text-center"><h2 class="text-3xl font-bold text-slate-900">çŸ¥è­˜å»ºæ§‹è«–å£‡</h2></div>
            <div class="flex justify-between items-center mb-6">
                <div id="category-filters" class="flex gap-2 overflow-x-auto">${window.app.generateCategoryFilters()}</div>
                ${window.state.user.role === 'teacher' ? `<button onclick="window.app.openCreateTopic()" class="bg-indigo-600 text-white px-5 py-2 rounded-lg shadow"><i class="fa-solid fa-plus"></i> æ–°å¢ä¸»é¡Œ</button>` : ''}
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                ${visibleTopics.map(t => `
                <div onclick="window.app.enterTopic('${t.id}')" class="bg-white rounded-xl border p-5 cursor-pointer hover:shadow-lg transition relative group">
                    <h3 class="font-bold text-lg mb-2 group-hover:text-indigo-600">${t.name}</h3>
                    <p class="text-slate-500 text-sm mb-4 line-clamp-2">${t.desc}</p>
                    <div class="flex justify-between text-xs text-slate-400 pt-3 border-t">
                        <span><i class="fa-solid fa-user"></i> ${window.state.userList[t.author]?.name || 'Unknown'}</span>
                        ${window.state.user.role === 'teacher' ? `<button onclick="event.stopPropagation(); window.app.deleteTopic('${t.id}')" class="hover:text-red-500"><i class="fa-solid fa-trash"></i></button>` : ''}
                    </div>
                </div>`).join('')}
            </div>
        </div>`;
        
        // ç¶å®š filter æŒ‰éˆ•äº‹ä»¶
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => window.app.setFilter(e.target.dataset.category));
        });
    };

    window.ui.renderCanvas = () => {
        const topic = window.state.topics.find(t => t.id === window.state.currentTopicId);
        if(!topic) return window.app.router('entrance');
        const nodes = window.state.nodes.filter(n => n.topicId === topic.id);
        const container = document.getElementById('app-container');
        
        container.innerHTML = `
        <div class="absolute top-4 left-4 z-40 flex gap-2">
            <button onclick="window.app.router('entrance')" class="bg-white px-3 py-2 rounded shadow text-slate-600"><i class="fa-solid fa-arrow-left"></i></button>
            <div class="bg-white px-4 py-2 rounded shadow font-bold text-slate-700">${topic.name}</div>
        </div>
        <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 z-40">
            <button onclick="window.app.canvas.toggleMode()" class="bg-white px-4 py-2 rounded-full shadow text-sm font-bold flex items-center gap-2">
                ${window.state.canvas.isPanMode ? '<i class="fa-solid fa-hand"></i> æ‹–æ›³æ¨¡å¼' : '<i class="fa-regular fa-square"></i> é¸å–æ¨¡å¼'}
            </button>
        </div>
        <div class="absolute bottom-8 right-8 z-40">
            <button onclick="window.app.openComposer(null)" class="bg-indigo-600 text-white w-14 h-14 rounded-full shadow-lg text-xl hover:scale-105 transition"><i class="fa-solid fa-plus"></i></button>
        </div>
        
        <div id="canvas-wrapper" class="w-full h-full overflow-hidden relative bg-slate-50"
             onmousedown="window.app.canvas.startPan(event)" onmousemove="window.app.canvas.pan(event)" onmouseup="window.app.canvas.endPan(event)">
            <div id="canvas-bg" style="position:absolute; width:100%; height:100%; background-image:radial-gradient(#cbd5e1 1px, transparent 1px); background-size:20px 20px;"></div>
            <div id="canvas-content" class="absolute top-0 left-0 w-full h-full origin-top-left">
                <svg id="connections-layer" class="absolute top-0 left-0 w-[5000px] h-[5000px] pointer-events-none z-0"></svg>
                <div id="nodes-layer" class="z-10">
                    ${nodes.map(n => {
                        const s = window.SCAFFOLDS[n.type];
                        return `<div id="node-${n.id}" class="absolute w-72 bg-white rounded-xl shadow-md border border-slate-200 flex flex-col" style="left:${n.x}px; top:${n.y}px;"
                                onmousedown="event.stopPropagation(); window.app.canvas.startDragNode(event, '${n.id}')">
                            <div class="px-3 py-2 ${s.bgSoft} border-b ${s.border} flex items-center gap-2 rounded-t-xl cursor-move">
                                <span class="w-5 h-5 rounded-full ${s.color} text-white flex justify-center items-center text-xs"><i class="fa-solid ${s.icon}"></i></span>
                                <span class="text-xs font-bold ${s.text}">${s.label}</span>
                            </div>
                            <div class="p-3 text-sm text-slate-700 bg-white"><h4 class="font-bold mb-1 truncate">${n.title}</h4><p class="line-clamp-2 text-xs text-slate-500">${n.content}</p></div>
                            <div class="px-3 py-2 bg-slate-50 border-t flex justify-between text-xs text-slate-400 rounded-b-xl">
                                <span>${window.state.userList[n.author]?.name}</span>
                                <div class="flex gap-2">
                                    <button onclick="window.app.openComposer('${n.id}')"><i class="fa-solid fa-reply"></i></button>
                                </div>
                            </div>
                        </div>`
                    }).join('')}
                </div>
            </div>
        </div>`;
        
        // ç¹ªè£½é€£ç·š
        setTimeout(() => {
            const layer = document.getElementById('connections-layer');
            const paths = nodes.filter(n => n.parentId).map(n => {
                const p = nodes.find(x => x.id === n.parentId);
                if(!p) return '';
                // ç°¡å–®è¨ˆç®—ä¸­å¿ƒé»é€£ç·š
                const sx = p.x + 144, sy = p.y + 100, ex = n.x + 144, ey = n.y;
                return `<path d="M ${sx} ${sy} L ${ex} ${ey}" stroke="#cbd5e1" stroke-width="2" fill="none" />`;
            }).join('');
            if(layer) layer.innerHTML = paths;
            window.app.canvas.applyTransform();
        }, 0);
    };

    window.ui.closeModal = (id) => document.getElementById(id).classList.add('hidden');
    window.ui.showToast = (msg) => {
        const div = document.createElement('div');
        div.className = "fixed bottom-10 right-10 bg-slate-800 text-white px-4 py-2 rounded shadow-lg z-50";
        div.innerText = msg;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 3000);
    };
    window.ui.updateNav = (view) => {
        document.querySelectorAll('.nav-btn, .mobile-nav-btn').forEach(btn => {
            if(btn.dataset.nav === view) btn.classList.add('active','text-indigo-600');
            else btn.classList.remove('active','text-indigo-600');
        });
    };
    
    // åƒåœ¾æ¡¶ä»‹é¢ (ç°¡åŒ–ç‰ˆ)
    window.ui.renderTrashList = () => {
        const list = document.getElementById('trash-list');
        if(!list) return;
        list.innerHTML = window.state.trash.length === 0 ? '<div class="text-center p-4 text-slate-400">å›æ”¶æ¡¶æ˜¯ç©ºçš„</div>' : 
            window.state.trash.map(t => `<div class="p-2 border-b">${t.type} deleted</div>`).join('');
    };

    // å•Ÿå‹•ç›£è½ (åˆå§‹åŒ–)
    console.log("ğŸš€ KB Platform Ready. Waiting for Firebase...");
</script>
</body>
</html>